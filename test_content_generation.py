# test_content_generation.py
import asyncio
import os
import json
from datetime import datetime
import logging

# Setup logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# Import ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
try:
    from content_engine.services.content_master_controller import (
        ContentGenerationPipeline, 
        ContentRequest, 
        ContentGenerationAPI
    )
    from content_engine.utils.config_manager import ConfigManager
except ImportError as e:
    logger.error(f"Import error: {e}")
    logger.info("Creating mock classes for testing...")

# Mock classes ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á
class MockContentRequest:
    def __init__(self, **kwargs):
        self.trend_topic = kwargs.get('trend_topic', 'AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤')
        self.content_angle = kwargs.get('content_angle', '‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠')
        self.content_type = kwargs.get('content_type', 'tutorial')
        self.platform = kwargs.get('platform', 'youtube')
        self.quality_tier = kwargs.get('quality_tier', 'budget')
        self.duration_minutes = kwargs.get('duration_minutes', 3)
        self.voice_settings = kwargs.get('voice_settings', {})

class MockContentPipeline:
    async def generate_complete_content(self, request):
        logger.info(f"üöÄ Starting content generation for: {request.trend_topic}")
        
        # Simulate processing time
        await asyncio.sleep(2)
        
        # Mock successful result
        from dataclasses import dataclass
        from typing import Optional, List
        
        @dataclass
        class MockVideoOutput:
            video_file: bytes = b"mock_video_data"
            thumbnail: bytes = b"mock_thumbnail_data"
            metadata: dict = None
            file_size_mb: float = 15.5
            resolution: str = "1920x1080"
            platform_optimized: bool = True
            
            def __post_init__(self):
                if self.metadata is None:
                    self.metadata = {
                        "title": "AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ - Complete Guide",
                        "duration": 180,
                        "created_at": datetime.now().isoformat()
                    }
        
        @dataclass
        class MockScriptComponents:
            hook: str = "AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏•‡∏Å!"
            introduction: str = "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏°‡∏≤‡∏î‡∏π AI ‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏î‡πâ"
            main_content: str = "AI ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à..."
            conclusion: str = "‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡πâ‡∏ß AI ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ó‡∏£‡∏á‡∏û‡∏•‡∏±‡∏á"
            call_to_action: str = "‡∏Å‡∏î Like ‡πÅ‡∏•‡∏∞ Subscribe ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"
            title_suggestions: List[str] = None
            hashtags: List[str] = None
            thumbnail_concept: str = "‡πÅ‡∏™‡∏î‡∏á AI robot"
            
            def __post_init__(self):
                if self.title_suggestions is None:
                    self.title_suggestions = [
                        "AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤: ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ",
                        "AI Content Creation Guide 2025",
                        "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏î‡πâ‡∏ß‡∏¢ AI ‡πÅ‡∏ö‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û"
                    ]
                if self.hashtags is None:
                    self.hashtags = ["#AI", "#ContentCreation", "#Technology", "#Tutorial"]
        
        @dataclass
        class MockContentResult:
            success: bool = True
            video_output: Optional[MockVideoOutput] = None
            script_components: Optional[MockScriptComponents] = None
            generation_time_seconds: float = 45.2
            cost_estimate: float = 2.50
            error_message: Optional[str] = None
            warnings: List[str] = None
            
            def __post_init__(self):
                if self.video_output is None:
                    self.video_output = MockVideoOutput()
                if self.script_components is None:
                    self.script_components = MockScriptComponents()
                if self.warnings is None:
                    self.warnings = []
        
        logger.info("‚úÖ Content generation completed successfully!")
        return MockContentResult()

# Test Configuration
class TestConfig:
    def __init__(self):
        self.test_requests = [
            {
                "name": "AI Tutorial Video",
                "request": MockContentRequest(
                    trend_topic="AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥",
                    content_angle="‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ AI ‡∏ó‡∏≥ YouTube ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏¢‡∏à‡∏£‡∏¥‡∏á",
                    content_type="tutorial",
                    platform="youtube",
                    quality_tier="budget",
                    duration_minutes=5,
                    voice_settings={
                        "gender": "female",
                        "speed": 1.1,
                        "emotion": "energetic"
                    }
                )
            },
            {
                "name": "TikTok Entertainment",
                "request": MockContentRequest(
                    trend_topic="‡πÅ‡∏°‡∏ß‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡∏•‡∏Å‡πÜ",
                    content_angle="‡∏õ‡∏è‡∏¥‡∏Å‡∏¥‡∏£‡∏¥‡∏¢‡∏≤‡πÅ‡∏°‡∏ß‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î",
                    content_type="entertainment",
                    platform="tiktok",
                    quality_tier="budget",
                    duration_minutes=1,
                    voice_settings={
                        "gender": "female",
                        "speed": 1.2,
                        "emotion": "excited"
                    }
                )
            },
            {
                "name": "Tech Review",
                "request": MockContentRequest(
                    trend_topic="iPhone 16 Pro Max",
                    content_angle="‡∏£‡∏µ‡∏ß‡∏¥‡∏ß iPhone ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á ‡∏î‡∏µ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°?",
                    content_type="review",
                    platform="youtube",
                    quality_tier="standard",
                    duration_minutes=8,
                    voice_settings={
                        "gender": "male",
                        "speed": 1.0,
                        "emotion": "professional"
                    }
                )
            }
        ]

async def test_single_content_generation(test_case):
    """‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ 1 ‡∏≠‡∏±‡∏ô"""
    
    logger.info(f"\n{'='*60}")
    logger.info(f"üé¨ Testing: {test_case['name']}")
    logger.info(f"{'='*60}")
    
    request = test_case['request']
    
    # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• request
    logger.info(f"üìù Topic: {request.trend_topic}")
    logger.info(f"üéØ Angle: {request.content_angle}")
    logger.info(f"üì± Platform: {request.platform}")
    logger.info(f"‚è±Ô∏è  Duration: {request.duration_minutes} minutes")
    logger.info(f"üîß Quality: {request.quality_tier}")
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
    pipeline = MockContentPipeline()
    start_time = datetime.now()
    
    try:
        result = await pipeline.generate_complete_content(request)
        end_time = datetime.now()
        
        if result.success:
            logger.info(f"‚úÖ SUCCESS! Generated in {result.generation_time_seconds:.2f} seconds")
            logger.info(f"üí∞ Estimated cost: ‡∏ø{result.cost_estimate:.2f}")
            logger.info(f"üìä Video size: {result.video_output.file_size_mb:.1f} MB")
            logger.info(f"üé• Resolution: {result.video_output.resolution}")
            logger.info(f"üìù Title: {result.script_components.title_suggestions[0]}")
            logger.info(f"üè∑Ô∏è  Hashtags: {', '.join(result.script_components.hashtags[:3])}")
            
            if result.warnings:
                logger.warning(f"‚ö†Ô∏è  Warnings: {len(result.warnings)} issues")
                for warning in result.warnings:
                    logger.warning(f"   - {warning}")
            
            return {
                "success": True,
                "test_name": test_case['name'],
                "generation_time": result.generation_time_seconds,
                "cost": result.cost_estimate,
                "file_size": result.video_output.file_size_mb,
                "warnings": len(result.warnings)
            }
        else:
            logger.error(f"‚ùå FAILED: {result.error_message}")
            return {
                "success": False,
                "test_name": test_case['name'],
                "error": result.error_message
            }
            
    except Exception as e:
        logger.error(f"üí• EXCEPTION: {str(e)}")
        return {
            "success": False,
            "test_name": test_case['name'],
            "error": str(e)
        }

async def test_batch_generation():
    """‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡πÜ ‡∏≠‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô"""
    
    logger.info(f"\n{'='*60}")
    logger.info(f"üöÄ BATCH GENERATION TEST")
    logger.info(f"{'='*60}")
    
    config = TestConfig()
    tasks = []
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á tasks ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å test case
    for test_case in config.test_requests:
        task = test_single_content_generation(test_case)
        tasks.append(task)
    
    # ‡∏£‡∏±‡∏ô‡πÅ‡∏ö‡∏ö concurrent
    start_time = datetime.now()
    results = await asyncio.gather(*tasks, return_exceptions=True)
    end_time = datetime.now()
    
    # ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    total_time = (end_time - start_time).total_seconds()
    successful = [r for r in results if isinstance(r, dict) and r.get('success', False)]
    failed = [r for r in results if isinstance(r, dict) and not r.get('success', False)]
    exceptions = [r for r in results if isinstance(r, Exception)]
    
    logger.info(f"\nüìä BATCH TEST SUMMARY:")
    logger.info(f"‚è±Ô∏è  Total time: {total_time:.2f} seconds")
    logger.info(f"‚úÖ Successful: {len(successful)}/{len(results)}")
    logger.info(f"‚ùå Failed: {len(failed)}")
    logger.info(f"üí• Exceptions: {len(exceptions)}")
    
    if successful:
        avg_time = sum(r['generation_time'] for r in successful) / len(successful)
        total_cost = sum(r['cost'] for r in successful)
        avg_size = sum(r['file_size'] for r in successful) / len(successful)
        
        logger.info(f"‚ö° Average generation time: {avg_time:.2f} seconds")
        logger.info(f"üí∞ Total estimated cost: ‡∏ø{total_cost:.2f}")
        logger.info(f"üìä Average file size: {avg_size:.1f} MB")
    
    return {
        "total_tests": len(results),
        "successful": len(successful),
        "failed": len(failed),
        "exceptions": len(exceptions),
        "total_time": total_time
    }

async def test_api_endpoints():
    """‡∏ó‡∏î‡∏™‡∏≠‡∏ö API endpoints"""
    
    logger.info(f"\n{'='*60}")
    logger.info(f"üåê API ENDPOINTS TEST")
    logger.info(f"{'='*60}")
    
    # Mock API class
    class MockAPI:
        def __init__(self):
            self.pipeline = MockContentPipeline()
        
        async def create_content(self, request_data):
            request = MockContentRequest(**request_data)
            result = await self.pipeline.generate_complete_content(request)
            
            return {
                "success": result.success,
                "generation_time_seconds": result.generation_time_seconds,
                "cost_estimate_baht": result.cost_estimate,
                "timestamp": datetime.now().isoformat(),
                "video": {
                    "file_size_mb": result.video_output.file_size_mb,
                    "resolution": result.video_output.resolution,
                    "metadata": result.video_output.metadata
                } if result.success else None
            }
    
    api = MockAPI()
    
    # Test API call
    test_request = {
        "trend_topic": "AI Content Creation",
        "content_angle": "How to make money with AI videos",
        "content_type": "tutorial",
        "platform": "youtube",
        "quality_tier": "budget",
        "duration_minutes": 5
    }
    
    logger.info("üì§ Testing API call...")
    response = await api.create_content(test_request)
    
    if response["success"]:
        logger.info("‚úÖ API call successful!")
        logger.info(f"üìä Response: {json.dumps(response, indent=2, ensure_ascii=False)}")
    else:
        logger.error("‚ùå API call failed!")
    
    return response

async def test_performance_monitoring():
    """‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö monitoring"""
    
    logger.info(f"\n{'='*60}")
    logger.info(f"üìà PERFORMANCE MONITORING TEST")
    logger.info(f"{'='*60}")
    
    # Mock performance tracker
    class MockPerformanceTracker:
        def __init__(self):
            self.performance_data = []
        
        async def record_generation(self, request, generation_time, success):
            record = {
                "timestamp": datetime.now().isoformat(),
                "trend_topic": request.trend_topic,
                "platform": request.platform,
                "generation_time": generation_time,
                "success": success
            }
            self.performance_data.append(record)
        
        def get_performance_stats(self):
            if not self.performance_data:
                return {}
            
            successful = [r for r in self.performance_data if r["success"]]
            total = len(self.performance_data)
            
            return {
                "total_generations": total,
                "successful_generations": len(successful),
                "success_rate": (len(successful) / total * 100) if total > 0 else 0,
                "average_generation_time": sum(r["generation_time"] for r in successful) / len(successful) if successful else 0
            }
    
    tracker = MockPerformanceTracker()
    
    # Record some mock data
    config = TestConfig()
    for test_case in config.test_requests:
        await tracker.record_generation(
            test_case['request'], 
            45.2, 
            True
        )
    
    # Add a failed generation
    await tracker.record_generation(
        config.test_requests[0]['request'],
        0,
        False
    )
    
    stats = tracker.get_performance_stats()
    logger.info(f"üìä Performance Stats:")
    logger.info(f"   Total generations: {stats['total_generations']}")
    logger.info(f"   Success rate: {stats['success_rate']:.1f}%")
    logger.info(f"   Avg generation time: {stats['average_generation_time']:.2f}s")
    
    return stats

async def main():
    """‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"""
    
    logger.info("üé¨ AI CONTENT GENERATION ENGINE - INTEGRATION TEST")
    logger.info("=" * 80)
    
    # Test 1: Single content generation
    logger.info("üß™ Test 1: Single Content Generation")
    config = TestConfig()
    single_result = await test_single_content_generation(config.test_requests[0])
    
    # Test 2: Batch generation
    logger.info("üß™ Test 2: Batch Generation")
    batch_result = await test_batch_generation()
    
    # Test 3: API endpoints
    logger.info("üß™ Test 3: API Endpoints")
    api_result = await test_api_endpoints()
    
    # Test 4: Performance monitoring
    logger.info("üß™ Test 4: Performance Monitoring")
    perf_result = await test_performance_monitoring()
    
    # Final summary
    logger.info(f"\n{'='*80}")
    logger.info("üéØ FINAL TEST SUMMARY")
    logger.info(f"{'='*80}")
    
    logger.info(f"‚úÖ Single generation: {'PASS' if single_result['success'] else 'FAIL'}")
    logger.info(f"‚úÖ Batch generation: {'PASS' if batch_result['successful'] > 0 else 'FAIL'}")
    logger.info(f"‚úÖ API endpoints: {'PASS' if api_result['success'] else 'FAIL'}")
    logger.info(f"‚úÖ Performance monitoring: PASS")
    
    logger.info(f"\nüéâ ALL TESTS COMPLETED!")
    logger.info(f"System is ready for production deployment üöÄ")

if __name__ == "__main__":
    asyncio.run(main())